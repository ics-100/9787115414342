# 第3章 完善MBR

|本期版本| 上期版本
|:---:|:---:
`Fri Apr  5 12:09:42 CST 2024` | -

## 3.1 地址、section、vstart 浅尝辄止

### 3.1.1 什么是地址

* 地址只是数字，描述各种符号在源程序中的位置，**它是源代码中各符号偏移文件开头的距离**
* `ndisasm` 反汇编
* 地址等于上一个地址+上一个地址处内容的长度

### 3.1.3 什么是 vstart

* `virtual start address` 虚拟起始地址, 它被用来计算在该 section 内的所有**内存引用地址**。
* `vstart` 和 `org` 功能是一样的，把后面所有数据地址以 `xxx`  开始编

## 3.2 CPU 的实模式

**3.2.2 实模式下的寄存器**


### 3.2.3 实模式下内存分段由来

* 用最简单的 8086 CPU 学习，这才更容易理解和看透 CPU 运行机制
* 高端内存区(High Memory Area, HMA)、地址回卷

**3.2.4 实模式下CPU内存寻址方式**

* 寄存器寻址
* 立即数寻址
* 内存寻址： 直接/基址/变址/基址变址
* 最终起决定作用的、有效的是段内偏移地址，所以段内偏移地址称为有效地址 

1 - 基址寻址

* bx寄存器的默认段寄存器是DS， bp寄存器的默认段寄存器是SS
* sp 寄存器作为栈顶指针，相当于栈中数据的游标，这是专门给push指令和pop指令做导航用的寄存器
* 标志寄存器eflags 无法直接修改，只能用pushf把指令eflags寄存器的内容压到栈中，我们在栈中修改完成后，在用popf把它弹回到eflags中
* 一个最重要的应用就是在栈中保存局部变量和函数参数

2 - 变址寻址

*  寄存器由 bx、bp 换成了 si 和 di

3 - 基址变址寻址


**3.2.5 栈到底是什么玩意儿**


* 假如当前栈顶是0x1233E, 栈顶数据占2字节的话，其范围是0x1233E~0x1233F


**3.2.6 实模式下的ret**

* `ret(return)` 指令的功能是在栈顶弹出2字节的内容来替换IP寄存器
* `retf(return far) `是从栈顶取4字节，栈顶处的2字节用来替换IP寄存器，另外的2字节用来替换CS寄存器

**3.2.7 实模式下的call**

* `jmp`  属于一去不回头地去执行新的代码

1 - 16位实模式相对近调用(IP)
2 - 16位实模式间接绝对近调用(IP)
3 - 16位实模式直接绝对远调用(CS:IP)
4 - 16位实模式间接绝对远调用(CS:IP)

```bash
b 0x900
c
trace on # 打开反汇编，每执行一句都会反汇编

```

## 3.3 让我们直接对显示器说点什么吧

**3.3.2 显卡概述**

**3.3.3 显卡、显存、显示器**

* 显存是从 `0xB8000` 到 `0xBFFFF` 范围是32KB
* 一屏幕可以显示2000个字，显示器上每个自负占2个字节代销， 故每屏字符实际占用4000字节
* 我们32KB可以容纳约等于8屏的数据



## 3.4 bochs 调试方法 - @TODO

* `help command`
* `x` 线性地址 / `xp` 物理地址 
* bochs 中用到的字并不是2字节，而是4字节
* 显示单元, 默认4字节, 指定显示单元后，以后就以此显示单元为准,不会自动恢复为默认的4字节
* u ，用来将内存数据反汇编成指令
* `info ivt`
* nm 命令用来列出可执行文件的符号表及其地址，在不加参数的情况下，默认输出“地址”“符号类型”
* `info gdt 3`

## 3.5 硬盘介绍

* 机械式硬盘的寻道时间是整个硬盘的瓶颈
* 硬盘控制器和硬盘终于在一 起了，这种接口便称为集成设备电路（Integrated Drive Electronics，IDE）
* 此接口使用的技术规范归纳成为全球硬盘标准，这样就产生了 ATA（Advan Technology Attachment）
* 前 几年刚出道的硬盘串行接口（Serial ATA，SATA），由于其是串行，所 以之前的 ATA 接口只好称为并行 ATA，即（Parallel ATA，PATA）
* 一个 IDE 线上可以挂两块硬盘，一个 是主盘（Master），一个是从盘（Slave）。
* 这两个接口也是以 0 为起始编号的，一个称为 IDE0，另一个称为 IDE1。不过按 ATA 的 说法，这两个插槽称为通道，IDE0 叫作 Primary 通道，IDE1 叫作 Secondary 通道。

**3.5.3 硬盘控制器端口**

* 总之我当初看 AT 手册的时候就被吓到了， 有兴趣的同学可以下载 AT_Attachment_with_Packet_Interface，该手册一共 3 卷
* 这是一 种逻辑上为扇区址的方法，全称为逻辑块地址（Logical Block Address）。
* LBA 有两种，一种是 LBA28，用 28 位比特来描述一个扇区的地址
* 另外一种是 LBA48，用 48 位比特来描述一个扇区的地址
* identify：0xEC，即硬盘识别。

## 3.6 让 MBR 使用硬盘

* 这个`%include` 是 nasm 编译器中的预处理指令，意思是让编译器在 编译之前把 boot.inc 文件包含进来。
* 咱们的虚拟硬盘属于 ata0，是 Primary 通道
* 105 行的 nop 表示空操作，即什么也不做，只是为了增加延迟，相当于 sleep 了一小下，目 的是减少打扰硬盘的工作

```s
# 本次的编译较之前相比，多加了一个参数 -I
nasm -I include/ -o mbr.bin mbr.S
```